- hosts: tag_Name_k8s_master
  become: yes
  tasks:
          - name: Add kubernetes YUM repositoy
            yum_repository:
                  name: Kubernetes
                  baseurl: "https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch"
                  enabled: yes
                  gpgcheck: yes
                  repo_gpgcheck: yes
                  gpgkey: "https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg"
                  description: Kubernetes Repository
          - name: Install kubeadm, kubectl, kubelet and iproute-tc packages
            package:
                  name:
                          - kubelet
                          - kubeadm
                          - kubectl
                          - iproute-tc
                  state: present
          - name: Start kubelet service
            service:
                  name: kubelet
                  state: started
                  enabled: yes
          - name: Check if k8s images are present
            shell: "docker images | grep k8s | wc -l"
            register: x
          - name: Pull k8s images
            command: kubeadm config images pull
            when: 'x.stdout != "7"'
          - name: Change Docker cgroupdriver to systemd
            copy:
                  content: >
                            {
                                      "exec-opts": ["native.cgroupdriver=systemd"]
                            }
                  dest: /etc/docker/daemon.json
            register: y
          - name: Restart docker service
            service:
                  name: docker
                  state: restarted
            when: y.changed is true
          - name: Set bridge-nf-call-iptables to 1
            shell: 'echo "1" >> /proc/sys/net/bridge/bridge-nf-call-iptables'
            changed_when: false
          - name: kubeadm init
            shell: kubeadm init --pod-network-cidr=10.240.0.0/16  --ignore-preflight-errors=NumCPU --ignore-preflight-errors=Mem 2> hi.txt | tail -n 2 && rm -rf hi.txt
            args:
                    creates: /etc/kubernetes/admin.conf
            register: z
          - name: Get previous output
            debug:
                  var: z
          - name: Get token
            local_action:
                  module: copy
                  content: "{{ z.stdout }}"
                  dest: /tmp/token
